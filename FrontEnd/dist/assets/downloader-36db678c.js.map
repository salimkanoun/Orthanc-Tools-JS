{"version":3,"file":"downloader-36db678c.js","sources":["../../node_modules/native-file-system-adapter/src/adapters/downloader.js"],"sourcesContent":["/* global Blob, DOMException, Response, MessageChannel */\n\nimport { errors } from '../util.js'\nimport config from '../config.js'\n\nconst {\n  WritableStream,\n  TransformStream,\n  DOMException,\n  Blob\n} = config\n\nconst { GONE } = errors\n// @ts-ignore\nconst isSafari = /constructor/i.test(window.HTMLElement) || window.safari || window.WebKitPoint\n\nexport class FileHandle {\n  constructor (name = 'unkown') {\n    this.name = name\n    this.kind = 'file'\n  }\n\n  async getFile () {\n    throw new DOMException(...GONE)\n  }\n\n  async isSameEntry(other) {\n    return this === other\n  }\n\n  /**\n   * @param {object} [options={}]\n   */\n  async createWritable (options = {}) {\n    const sw = await navigator.serviceWorker?.getRegistration()\n    const link = document.createElement('a')\n    const ts = new TransformStream()\n    const sink = ts.writable\n\n    link.download = this.name\n\n    if (isSafari || !sw) {\n      /** @type {Blob[]} */\n      let chunks = []\n      ts.readable.pipeTo(new WritableStream({\n        write (chunk) {\n          chunks.push(new Blob([chunk]))\n        },\n        close () {\n          const blob = new Blob(chunks, { type: 'application/octet-stream; charset=utf-8' })\n          chunks = []\n          link.href = URL.createObjectURL(blob)\n          link.click()\n          setTimeout(() => URL.revokeObjectURL(link.href), 10000)\n        }\n      }))\n    } else {\n      const { writable, readablePort } = new RemoteWritableStream(WritableStream)\n      // Make filename RFC5987 compatible\n      const fileName = encodeURIComponent(this.name).replace(/['()]/g, escape).replace(/\\*/g, '%2A')\n      const headers = {\n        'content-disposition': \"attachment; filename*=UTF-8''\" + fileName,\n        'content-type': 'application/octet-stream; charset=utf-8',\n        ...(options.size ? { 'content-length': options.size } : {})\n      }\n\n      const keepAlive = setTimeout(() => sw.active.postMessage(0), 10000)\n\n      ts.readable.pipeThrough(new TransformStream({\n        transform (chunk, ctrl) {\n          if (chunk instanceof Uint8Array) return ctrl.enqueue(chunk)\n          const reader = new Response(chunk).body.getReader()\n          const pump = _ => reader.read().then(e => e.done ? 0 : pump(ctrl.enqueue(e.value)))\n          return pump()\n        }\n      })).pipeTo(writable).finally(() => {\n        clearInterval(keepAlive)\n      })\n\n      // Transfer the stream to service worker\n      sw.active.postMessage({\n        url: sw.scope + fileName,\n        headers,\n        readablePort\n      }, [readablePort])\n\n      // Trigger the download with a hidden iframe\n      const iframe = document.createElement('iframe')\n      iframe.hidden = true\n      iframe.src = sw.scope + fileName\n      document.body.appendChild(iframe)\n    }\n\n    return sink.getWriter()\n  }\n}\n\nconst WRITE = 0\nconst PULL = 0\nconst ERROR = 1\nconst ABORT = 1\nconst CLOSE = 2\n\nclass MessagePortSink {\n  /** @param {MessagePort} port */\n  constructor (port) {\n    port.onmessage = event => this._onMessage(event.data)\n    this._port = port\n    this._resetReady()\n  }\n\n  start (controller) {\n    this._controller = controller\n    // Apply initial backpressure\n    return this._readyPromise\n  }\n\n  write (chunk) {\n    const message = { type: WRITE, chunk }\n\n    // Send chunk\n    this._port.postMessage(message, [chunk.buffer])\n\n    // Assume backpressure after every write, until sender pulls\n    this._resetReady()\n\n    // Apply backpressure\n    return this._readyPromise\n  }\n\n  close () {\n    this._port.postMessage({ type: CLOSE })\n    this._port.close()\n  }\n\n  abort (reason) {\n    this._port.postMessage({ type: ABORT, reason })\n    this._port.close()\n  }\n\n  _onMessage (message) {\n    if (message.type === PULL) this._resolveReady()\n    if (message.type === ERROR) this._onError(message.reason)\n  }\n\n  _onError (reason) {\n    this._controller.error(reason)\n    this._rejectReady(reason)\n    this._port.close()\n  }\n\n  _resetReady () {\n    this._readyPromise = new Promise((resolve, reject) => {\n      this._readyResolve = resolve\n      this._readyReject = reject\n    })\n    this._readyPending = true\n  }\n\n  _resolveReady () {\n    this._readyResolve()\n    this._readyPending = false\n  }\n\n  _rejectReady (reason) {\n    if (!this._readyPending) this._resetReady()\n    this._readyPromise.catch(() => {})\n    this._readyReject(reason)\n    this._readyPending = false\n  }\n}\n\nclass RemoteWritableStream {\n  constructor (WritableStream) {\n    const channel = new MessageChannel()\n    this.readablePort = channel.port1\n    this.writable = new WritableStream(\n      new MessagePortSink(channel.port2)\n    )\n  }\n}\n"],"names":["WritableStream","TransformStream","DOMException","Blob","config","GONE","errors","isSafari","FileHandle","name","other","options","sw","_a","link","ts","sink","chunks","chunk","blob","writable","readablePort","RemoteWritableStream","fileName","headers","keepAlive","ctrl","reader","pump","_","e","iframe","WRITE","PULL","ERROR","ABORT","CLOSE","MessagePortSink","port","event","controller","message","reason","resolve","reject","channel"],"mappings":"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","x_google_ignoreList":[0]}